name: deploy-scaler

on:
  workflow_call:
    inputs:
      function_app_name:
        type: string
        required: true
      resource_group:
        type: string
        required: true
      aci_image:
        type: string
        required: true
      app_settings_json:
        type: string
        required: false
        default: "{}"
      restart_app:
        type: boolean
        required: false
        default: true
  repository_dispatch:
    types:
      - service-deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2.0.0
        with:
          creds: ${{ secrets.TDEI_CORE_AZURE_CREDS }}

      - name: Resolve inputs
        id: vars
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "function_app_name=${{ github.event.client_payload.function_app_name }}" >> "$GITHUB_OUTPUT"
            echo "resource_group=${{ github.event.client_payload.resource_group }}" >> "$GITHUB_OUTPUT"
            echo "aci_image=${{ github.event.client_payload.aci_image }}" >> "$GITHUB_OUTPUT"
            echo "restart_app=${{ github.event.client_payload.restart_app || 'true' }}" >> "$GITHUB_OUTPUT"
          else
            echo "function_app_name=${{ inputs.function_app_name }}" >> "$GITHUB_OUTPUT"
            echo "resource_group=${{ inputs.resource_group }}" >> "$GITHUB_OUTPUT"
            echo "aci_image=${{ inputs.aci_image }}" >> "$GITHUB_OUTPUT"
            echo "restart_app=${{ inputs.restart_app }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Log target environment
        shell: bash
        run: |
          echo "Deploying scaler to:"
          echo "  Function App: ${{ steps.vars.outputs.function_app_name }}"
          echo "  Resource Group: ${{ steps.vars.outputs.resource_group }}"
          echo "  ACI_IMAGE: ${{ steps.vars.outputs.aci_image }}"

      - name: Update app settings (ACI_IMAGE + extras)
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          app_settings = os.environ.get("APP_SETTINGS_JSON", "{}")
          data = json.loads(app_settings) if app_settings else {}
          data["ACI_IMAGE"] = os.environ["ACI_IMAGE"]
          with open("/tmp/appsettings.txt", "w", encoding="utf-8") as handle:
              for key, value in data.items():
                  handle.write(f"{key}={value}\n")
          PY
          echo "Updating only provided settings (no clearing of others)."
          az functionapp config appsettings set \
            --name "${{ steps.vars.outputs.function_app_name }}" \
            --resource-group "${{ steps.vars.outputs.resource_group }}" \
            --settings $(cat /tmp/appsettings.txt | tr '\n' ' ')
        env:
          ACI_IMAGE: ${{ steps.vars.outputs.aci_image }}
          APP_SETTINGS_JSON: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.app_settings_json || inputs.app_settings_json || '{}' }}

      - name: Restart function app
        if: ${{ steps.vars.outputs.restart_app == 'true' }}
        shell: bash
        run: |
          az functionapp restart \
            --name "${{ steps.vars.outputs.function_app_name }}" \
            --resource-group "${{ steps.vars.outputs.resource_group }}"
